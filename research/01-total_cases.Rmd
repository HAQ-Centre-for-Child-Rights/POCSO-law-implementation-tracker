# Total Cases {#total_cases}

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	eval=FALSE,
	message = FALSE,
	warning = FALSE
)

options(DT.options = list(pageLength = 5,dom='t',autowidth=TRUE,scrollX = TRUE))

source("../scripts/source_files.R")
```

```{sql connection=con, include=FALSE, output.var='db_tables'}
SELECT table_name FROM information_schema.tables
                 WHERE table_schema='public'
```


```{r total-cases-data}

cols_to_select <- c("district_code", "district_name", "state_code", "state_name", "complex_code", "court_code", "court_name", "court_no", "est_code", "cino", "case_no", "fil_no", "fil_year", "reg_no", "reg_year", "fir_no", "fir_year", "type_name", "date_of_decision", "date_of_filing", "dt_regis", "disp_name", "disp_nature", "police_station", "subordinate_court_no", "subordinate_court_case_type", "subordinate_court_case_no", "tranfer_est_flag")

all_cases <- dbxSelect(
  con,
  glue("select {paste0(cols_to_select,collapse = ',')} from case_details")
)
```

## Year on Year
```{sql connection=con, output.var='year_wise_cases'}
select a.*, b.pending_cases from (select state_name, district_name, reg_year, count(cino) as total_cases from case_details group by state_name, district_name, reg_year) as a LEFT JOIN (select state_name, district_name, reg_year, count(cino) as pending_cases from case_details where disp_nature = '0' group by state_name, district_name, reg_year) as b ON a.state_name=b.state_name AND a.district_name=b.district_name AND a.reg_year=b.reg_year
```

```{r year_wise_cases_sample, echo=FALSE, eval=TRUE}
year_wise_cases[sample(nrow(year_wise_cases),5),] %>% DT::datatable()
```


## Disposal Nature
```{sql connection=con, output.var='nature_of_disposal'}
select state_name, district_name, disp_name, disp_nature, count(cino) as total_cases from case_details where disp_nature != '0' group by state_name, district_name, disp_name, disp_nature
```

```{r nature_of_disposal_sample, echo=FALSE, eval=TRUE}
nature_of_disposal[sample(nrow(nature_of_disposal),5),] %>% DT::datatable()
```

## Offence wise
```{sql connection=con, output.var='nature_of_offence'}
select state_name, district_name, est_code, court_name, act_name_std, section_name_std, count(cino) as total_cases from (select c.act_name_std, c.section_name_std, d.* from acts_subset as c inner join (select a.*, b.state_name, b.district_name, b.est_code, b.court_name FROM case_acts as a LEFT JOIN case_details as b on a.cino=b.cino) as d on c.id = d.act) as e group by state_name, district_name, est_code, court_name, act_name_std, section_name_std
```

```{r nature_of_offence_sample, echo=FALSE, eval=TRUE}
nature_of_offence[sample(nrow(nature_of_offence),5),] %>% DT::datatable()
```

## Age of case
```{sql connection=con, output.var='case_age'}
select state_name, district_name, court_name, est_code, cino,reg_year, type_name, disp_name, disp_nature, dt_regis, date_of_filing, date_of_decision from case_details
```

```{r processing-case-age}
case_age$end_date <- case_age$date_of_decision 

# End date of a case should depend on when the data was downloaded for a state. This will ensure that we capture the correct status of a case (pending/disposed) as on the date of data-collection. 

# At present, we're using a fix date - 2020/03/31, but this will be updated as per the revised date of data collection for each state

case_age$end_date[is.na(case_age$end_date)] <- as.Date("2020-03-31")

case_age$age_of_case_interval <- lubridate::interval(case_age$date_of_filing,case_age$end_date)

case_age$age_of_case_days <- time_length(case_age$age_of_case_interval, "days")

# Remove cases with difference < 0
case_age <- case_age[case_age$age_of_case_days > 0,]

# Add month/year intervals for grouping
case_age$age_buckets <- findInterval(case_age$age_of_case_days, 
c(30L,90L,180L,365L, 730L, 1095L, 1460L, 1825L, 2190L, 2555L, 2920L, 3285L, 3650L,Inf),rightmost.closed = TRUE)

age_intervals <- data.frame('age_buckets'=seq(0,13),'age_interval'=c('one month','three months','six months','one year',"two years", "three years", "four years", "five years", "six years", "seven years", "eight years", "nine years", "ten years","more than 10 years"))
case_age <- left_join(case_age, age_intervals, by=NULL)
case_age_dataset <- case_age %>% group_by(state_name, district_name, court_name, est_code, type_name, disp_name, disp_nature, age_interval) %>% summarise(total_cases = length(cino))
```

```{r case_age_dataset_sample, echo=FALSE, eval=TRUE}
case_age_dataset[sample(nrow(case_age_dataset),5),] %>% DT::datatable()
```

## Cases pending trial at the end of each year
```{r}
case_age$pending_trial_year_flag <- 0
case_age$pending_trial_year_flag[case_age$age_of_case_days >= 365] <- 1

pending_trial_dataset <- case_age %>% filter(pending_trial_year_flag == 1) %>% group_by(state_name, district_name, reg_year, court_name, est_code, type_name, disp_name, disp_nature) %>% summarise(cases_pending_trial_yearly = length(cino))

total_yearly_cases <- case_age %>% group_by(state_name, district_name, reg_year, court_name, est_code, type_name, disp_name, disp_nature) %>% summarise(total_cases = length(cino))

yearly_cases_pendency_ratio <- left_join(total_yearly_cases, pending_trial_dataset, by=NULL)
yearly_cases_pendency_ratio$cases_pending_trial_yearly[is.na(yearly_cases_pendency_ratio$cases_pending_trial_yearly)] <- 0
```



```{r Writing Files}
write_csv(year_wise_cases,"datasets/year_wise_cases.csv")
write_csv(nature_of_disposal,"datasets/nature_of_disposal.csv")
write_csv(nature_of_offence,"datasets/nature_of_offence.csv")
write_csv(case_age_dataset,"datasets/case_age_dataset.csv")
write_csv(yearly_cases_pendency_ratio,"datasets/yearly_cases_pendency_ratio.csv")
```
